// Prisma Schema for IMS - Inventory Management System
// Malaysian SME Auto Parts, Hardware & Spare Parts Wholesalers

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATION & USERS
// ============================================

model Organization {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  industry      Industry @default(AUTO_PARTS)
  baseCurrency  String   @default("MYR")
  timezone      String   @default("Asia/Kuala_Lumpur")
  sstNumber     String? // Malaysian SST registration number
  businessRegNo String? // SSM registration number
  tin           String? // Tax Identification Number for MyInvois
  email         String?
  phone         String?
  website       String?
  logoUrl       String?
  settings      Json     @default("{}")
  address       Json? // JSON for flexible address structure
  status        Status   @default(ACTIVE)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  users          User[]
  warehouses     Warehouse[]
  items          Item[]
  itemGroups     ItemGroup[]
  categories     Category[]
  contacts       Contact[]
  salesOrders    SalesOrder[]
  invoices       Invoice[]
  purchaseOrders PurchaseOrder[]
  bills          Bill[]
  taxRates       TaxRate[]
  paymentTerms   PaymentTerm[]
  priceLists     PriceList[]

  @@index([slug])
  @@index([status])
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String
  name           String
  phone          String?
  avatarUrl      String?
  role           UserRole  @default(STAFF)
  organizationId String
  preferences    Json      @default("{}")
  status         Status    @default(ACTIVE)
  lastLoginAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Activity tracking
  salesOrders        SalesOrder[]        @relation("SalesOrderSalesPerson")
  createdSalesOrders SalesOrder[]        @relation("SalesOrderCreatedBy")
  createdItems       Item[]              @relation("ItemCreatedBy")
  createdInvoices    Invoice[]
  createdPOs         PurchaseOrder[]     @relation("PurchaseOrderCreatedBy")
  createdReceives    PurchaseReceive[]   @relation("PurchaseReceiveCreatedBy")
  createdBills       Bill[]              @relation("BillCreatedBy")
  createdVendorPmts  VendorPayment[]     @relation("VendorPaymentCreatedBy")
  createdAdjustments StockAdjustment[]   @relation("StockAdjustmentCreatedBy")
  createdTransfers   InventoryTransfer[] @relation("TransferCreatedBy")
  receivedTransfers  InventoryTransfer[] @relation("TransferReceivedBy")

  // Sales Returns & Credits
  createdSalesReturns  SalesReturn[]  @relation("SalesReturnCreatedBy")
  approvedSalesReturns SalesReturn[]  @relation("SalesReturnApprovedBy")
  receivedSalesReturns SalesReturn[]  @relation("SalesReturnReceivedBy")
  createdCreditNotes   CreditNote[]   @relation("CreditNoteCreatedBy")
  createdVendorCredits VendorCredit[] @relation("VendorCreditCreatedBy")

  @@index([organizationId])
  @@index([email])
  @@index([status])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ============================================
// ITEMS & INVENTORY
// ============================================

model Item {
  id              String   @id @default(cuid())
  organizationId  String
  sku             String
  name            String
  nameMalay       String? // Bahasa Malaysia name
  description     String?
  type            ItemType @default(INVENTORY)
  unit            String   @default("pcs")
  brand           String?
  partNumber      String? // OEM/Aftermarket part number
  crossReferences String[] // Alternative part numbers
  vehicleModels   String[] // Compatible vehicles (for auto parts)
  categoryId      String?
  itemGroupId     String?

  // Pricing
  costPrice    Decimal @default(0) @db.Decimal(15, 4)
  sellingPrice Decimal @default(0) @db.Decimal(15, 4)

  // Inventory settings
  reorderLevel   Decimal @default(0) @db.Decimal(15, 4)
  reorderQty     Decimal @default(0) @db.Decimal(15, 4)
  trackInventory Boolean @default(true)
  trackBatches   Boolean @default(false)
  trackSerials   Boolean @default(false)

  // Tax
  taxable   Boolean @default(true)
  taxRateId String?

  // Media
  images String[]

  // Metadata
  status      Status   @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category     Category?    @relation(fields: [categoryId], references: [id])
  itemGroup    ItemGroup?   @relation(fields: [itemGroupId], references: [id])
  taxRate      TaxRate?     @relation(fields: [taxRateId], references: [id])
  createdBy    User?        @relation("ItemCreatedBy", fields: [createdById], references: [id])

  // Stock relations
  stockLevels   StockLevel[]
  batches       Batch[]
  serialNumbers SerialNumber[]

  // Transaction relations
  salesOrderItems      SalesOrderItem[]
  invoiceItems         InvoiceItem[]
  purchaseOrderItems   PurchaseOrderItem[]
  purchaseReceiveItems PurchaseReceiveItem[]
  billItems            BillItem[]
  stockAdjustmentItems StockAdjustmentItem[]
  stockAdjustments     StockAdjustment[]       @relation("ItemAdjustments")
  transferItems        InventoryTransferItem[]
  salesReturnItems     SalesReturnItem[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([partNumber])
  @@index([status])
  @@index([categoryId])
}

model ItemGroup {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  attributes     Json     @default("[]") // [{name: "Size", options: ["S", "M", "L"]}]
  status         Status   @default(ACTIVE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items        Item[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model Category {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  nameMalay      String?
  description    String?
  parentId       String?
  sortOrder      Int      @default(0)
  status         Status   @default(ACTIVE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Self-reference for hierarchy
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items        Item[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([parentId])
}

// ============================================
// WAREHOUSES & STOCK
// ============================================

model Warehouse {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  code           String
  address        Json?
  phone          String?
  email          String?
  isDefault      Boolean  @default(false)
  status         Status   @default(ACTIVE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization     Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stockLevels      StockLevel[]
  batches          Batch[]
  serialNumbers    SerialNumber[]
  stockAdjustments StockAdjustment[]
  purchaseOrders   PurchaseOrder[]
  purchaseReceives PurchaseReceive[]
  salesOrders      SalesOrder[]
  transfersFrom    InventoryTransfer[] @relation("TransfersFrom")
  transfersTo      InventoryTransfer[] @relation("TransfersTo")
  salesReturns     SalesReturn[]

  @@unique([organizationId, code])
  @@index([organizationId])
}

model StockLevel {
  id             String   @id @default(cuid())
  itemId         String
  warehouseId    String
  stockOnHand    Decimal  @default(0) @db.Decimal(15, 4)
  committedStock Decimal  @default(0) @db.Decimal(15, 4) // Reserved for sales orders
  incomingStock  Decimal  @default(0) @db.Decimal(15, 4) // Expected from purchase orders
  updatedAt      DateTime @updatedAt

  // Relations
  item      Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([itemId, warehouseId])
  @@index([itemId])
  @@index([warehouseId])
}

model Batch {
  id              String    @id @default(cuid())
  itemId          String
  warehouseId     String
  batchNumber     String
  manufactureDate DateTime?
  expiryDate      DateTime?
  quantity        Decimal   @default(0) @db.Decimal(15, 4)
  status          Status    @default(ACTIVE)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  item      Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([itemId, warehouseId, batchNumber])
  @@index([itemId])
  @@index([warehouseId])
  @@index([expiryDate])
}

model SerialNumber {
  id           String       @id @default(cuid())
  itemId       String
  serialNumber String
  warehouseId  String?
  status       SerialStatus @default(IN_STOCK)
  soldToId     String? // Contact ID if sold
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  item      Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  warehouse Warehouse? @relation(fields: [warehouseId], references: [id])
  soldTo    Contact?   @relation(fields: [soldToId], references: [id])

  @@unique([itemId, serialNumber])
  @@index([itemId])
  @@index([warehouseId])
  @@index([status])
}

model StockAdjustment {
  id               String            @id @default(cuid())
  organizationId   String
  adjustmentNumber String            @unique
  warehouseId      String
  itemId           String?
  type             AdjustmentType
  quantity         Decimal?          @db.Decimal(15, 4)
  reason           String?
  date             DateTime          @default(now())
  adjustmentDate   DateTime          @default(now())
  status           TransactionStatus @default(DRAFT)
  notes            String?
  createdById      String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  warehouse Warehouse             @relation(fields: [warehouseId], references: [id])
  item      Item?                 @relation("ItemAdjustments", fields: [itemId], references: [id])
  createdBy User?                 @relation("StockAdjustmentCreatedBy", fields: [createdById], references: [id])
  items     StockAdjustmentItem[]

  @@index([organizationId])
  @@index([warehouseId])
  @@index([status])
  @@index([adjustmentDate])
}

model StockAdjustmentItem {
  id                String  @id @default(cuid())
  stockAdjustmentId String
  itemId            String
  quantityAdjusted  Decimal @db.Decimal(15, 4)
  reason            String?

  // Relations
  stockAdjustment StockAdjustment @relation(fields: [stockAdjustmentId], references: [id], onDelete: Cascade)
  item            Item            @relation(fields: [itemId], references: [id])

  @@index([stockAdjustmentId])
  @@index([itemId])
}

model InventoryTransfer {
  id                String         @id @default(cuid())
  organizationId    String
  transferNumber    String         @unique
  sourceWarehouseId String
  targetWarehouseId String
  transferDate      DateTime       @default(now())
  status            TransferStatus @default(DRAFT)
  notes             String?
  createdById       String?
  receivedById      String?
  receivedAt        DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  sourceWarehouse Warehouse               @relation("TransfersFrom", fields: [sourceWarehouseId], references: [id])
  targetWarehouse Warehouse               @relation("TransfersTo", fields: [targetWarehouseId], references: [id])
  createdBy       User?                   @relation("TransferCreatedBy", fields: [createdById], references: [id])
  receivedBy      User?                   @relation("TransferReceivedBy", fields: [receivedById], references: [id])
  items           InventoryTransferItem[]

  @@index([organizationId])
  @@index([sourceWarehouseId])
  @@index([targetWarehouseId])
  @@index([status])
  @@index([transferDate])
}

model InventoryTransferItem {
  id                  String  @id @default(cuid())
  inventoryTransferId String
  itemId              String
  quantityRequested   Decimal @db.Decimal(15, 4)
  quantityShipped     Decimal @default(0) @db.Decimal(15, 4)
  quantityReceived    Decimal @default(0) @db.Decimal(15, 4)
  notes               String?

  // Relations
  inventoryTransfer InventoryTransfer @relation(fields: [inventoryTransferId], references: [id], onDelete: Cascade)
  item              Item              @relation(fields: [itemId], references: [id])

  @@index([inventoryTransferId])
  @@index([itemId])
}

// ============================================
// CONTACTS (CUSTOMERS & VENDORS)
// ============================================

model Contact {
  id              String      @id @default(cuid())
  organizationId  String
  type            ContactType
  companyName     String
  displayName     String
  firstName       String?
  lastName        String?
  email           String?
  phone           String?
  mobile          String?
  website         String?
  taxNumber       String? // SST registration number
  creditLimit     Decimal?    @db.Decimal(15, 2)
  paymentTermId   String?
  priceListId     String?
  billingAddress  Json?
  shippingAddress Json?
  notes           String?
  status          Status      @default(ACTIVE)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  paymentTerm  PaymentTerm? @relation(fields: [paymentTermId], references: [id])
  priceList    PriceList?   @relation(fields: [priceListId], references: [id])
  addresses    Address[]

  // Transaction relations (Customer)
  salesOrders  SalesOrder[]
  invoices     Invoice[]
  payments     Payment[]
  salesReturns SalesReturn[] @relation("SalesReturnCustomer")
  creditNotes  CreditNote[]  @relation("CreditNoteCustomer")

  // Transaction relations (Vendor)
  purchaseOrders   PurchaseOrder[]
  purchaseReceives PurchaseReceive[]
  bills            Bill[]
  vendorPayments   VendorPayment[]
  vendorCredits    VendorCredit[]    @relation("VendorCreditVendor")

  // Serial tracking
  serialNumbers SerialNumber[]

  @@index([organizationId])
  @@index([type])
  @@index([status])
}

model Address {
  id             String   @id @default(cuid())
  contactId      String
  contact        Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  label          String // "Main Office", "Warehouse KL", etc.
  addressLine1   String
  addressLine2   String?
  city           String
  state          String
  postcode       String
  country        String   @default("Malaysia")
  isDefault      Boolean  @default(false)
  isBilling      Boolean  @default(true)
  isShipping     Boolean  @default(true)
  phone          String?
  attention      String? // Contact person at address
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([contactId])
  @@index([organizationId])
}

// ============================================
// SALES MODULE
// ============================================

model SalesOrder {
  id               String           @id @default(cuid())
  organizationId   String
  orderNumber      String
  customerId       String
  orderDate        DateTime         @default(now())
  expectedShipDate DateTime?
  shippedDate      DateTime?
  status           SalesOrderStatus @default(DRAFT)
  invoiceStatus    InvoiceStatus    @default(NOT_INVOICED)
  paymentStatus    PaymentStatus    @default(UNPAID)
  shipmentStatus   ShipmentStatus   @default(NOT_SHIPPED)
  salesPersonId    String?
  warehouseId      String?
  referenceNumber  String?
  shippingAddress  Json?
  billingAddress   Json?
  subtotal         Decimal          @default(0) @db.Decimal(15, 2)
  discountType     DiscountType     @default(PERCENTAGE)
  discountValue    Decimal          @default(0) @db.Decimal(15, 2)
  discountAmount   Decimal          @default(0) @db.Decimal(15, 2)
  shippingCharges  Decimal          @default(0) @db.Decimal(15, 2)
  taxAmount        Decimal          @default(0) @db.Decimal(15, 2)
  total            Decimal          @default(0) @db.Decimal(15, 2)
  notes            String?
  termsConditions  String?
  createdById      String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Contact          @relation(fields: [customerId], references: [id])
  salesPerson  User?            @relation("SalesOrderSalesPerson", fields: [salesPersonId], references: [id])
  warehouse    Warehouse?       @relation(fields: [warehouseId], references: [id])
  createdBy    User?            @relation("SalesOrderCreatedBy", fields: [createdById], references: [id])
  items        SalesOrderItem[]
  invoices     Invoice[]
  salesReturns SalesReturn[]

  @@unique([organizationId, orderNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@index([orderDate])
}

model SalesOrderItem {
  id             String       @id @default(cuid())
  salesOrderId   String
  itemId         String
  description    String?
  quantity       Decimal      @db.Decimal(15, 4)
  invoicedQty    Decimal      @default(0) @db.Decimal(15, 4)
  shippedQty     Decimal      @default(0) @db.Decimal(15, 4)
  unit           String
  rate           Decimal      @db.Decimal(15, 4)
  discountType   DiscountType @default(PERCENTAGE)
  discountValue  Decimal      @default(0) @db.Decimal(15, 2)
  discountAmount Decimal      @default(0) @db.Decimal(15, 2)
  taxRateId      String?
  taxAmount      Decimal      @default(0) @db.Decimal(15, 2)
  amount         Decimal      @db.Decimal(15, 2)
  sortOrder      Int          @default(0)

  // Relations
  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  item       Item       @relation(fields: [itemId], references: [id])

  @@index([salesOrderId])
  @@index([itemId])
}

model Invoice {
  id              String        @id @default(cuid())
  organizationId  String
  invoiceNumber   String
  salesOrderId    String?
  customerId      String
  invoiceDate     DateTime      @default(now())
  dueDate         DateTime
  status          InvoiceStatus @default(DRAFT)
  paymentStatus   PaymentStatus @default(UNPAID)
  subtotal        Decimal       @default(0) @db.Decimal(15, 2)
  discountType    DiscountType  @default(PERCENTAGE)
  discountValue   Decimal       @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal       @default(0) @db.Decimal(15, 2)
  total           Decimal       @default(0) @db.Decimal(15, 2)
  amountPaid      Decimal       @default(0) @db.Decimal(15, 2)
  balance         Decimal       @default(0) @db.Decimal(15, 2)
  billingAddress  Json?
  paymentTermDays Int           @default(30)
  notes           String?
  termsConditions String?
  createdById     String?

  // Malaysian e-Invoice
  eInvoiceId     String? // MyInvois submission UUID
  eInvoiceStatus EInvoiceStatus?
  eInvoiceQrCode String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesOrder             SalesOrder?             @relation(fields: [salesOrderId], references: [id])
  customer               Contact                 @relation(fields: [customerId], references: [id])
  createdBy              User?                   @relation(fields: [createdById], references: [id])
  items                  InvoiceItem[]
  paymentAllocations     PaymentAllocation[]
  salesReturns           SalesReturn[]
  creditNoteApplications CreditNoteApplication[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@index([invoiceDate])
  @@index([dueDate])
}

model InvoiceItem {
  id             String       @id @default(cuid())
  invoiceId      String
  itemId         String
  description    String?
  quantity       Decimal      @db.Decimal(15, 4)
  unit           String
  rate           Decimal      @db.Decimal(15, 4)
  discountType   DiscountType @default(PERCENTAGE)
  discountValue  Decimal      @default(0) @db.Decimal(15, 2)
  discountAmount Decimal      @default(0) @db.Decimal(15, 2)
  taxRateId      String?
  taxAmount      Decimal      @default(0) @db.Decimal(15, 2)
  amount         Decimal      @db.Decimal(15, 2)
  sortOrder      Int          @default(0)

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  item    Item    @relation(fields: [itemId], references: [id])

  @@index([invoiceId])
  @@index([itemId])
}

model Payment {
  id               String            @id @default(cuid())
  organizationId   String
  paymentNumber    String
  customerId       String
  paymentDate      DateTime          @default(now())
  amount           Decimal           @db.Decimal(15, 2)
  paymentMethod    PaymentMethod
  referenceNumber  String?
  bankAccountId    String?
  isAdvancePayment Boolean           @default(false)
  notes            String?
  status           TransactionStatus @default(COMPLETED)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  customer    Contact             @relation(fields: [customerId], references: [id])
  allocations PaymentAllocation[]

  @@unique([organizationId, paymentNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([paymentDate])
}

model PaymentAllocation {
  id        String   @id @default(cuid())
  paymentId String
  invoiceId String
  amount    Decimal  @db.Decimal(15, 2)
  createdAt DateTime @default(now())

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([paymentId])
  @@index([invoiceId])
}

// ============================================
// PURCHASE MODULE
// ============================================

model PurchaseOrder {
  id              String              @id @default(cuid())
  organizationId  String
  orderNumber     String
  vendorId        String
  orderDate       DateTime            @default(now())
  expectedDate    DateTime?
  status          PurchaseOrderStatus @default(DRAFT)
  receiveStatus   ReceiveStatus       @default(NOT_RECEIVED)
  billStatus      BillStatus          @default(NOT_BILLED)
  referenceNumber String? // Vendor's quote/reference
  warehouseId     String?
  deliveryAddress Json?
  subtotal        Decimal             @default(0) @db.Decimal(15, 2)
  discountType    DiscountType        @default(PERCENTAGE)
  discountValue   Decimal             @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal             @default(0) @db.Decimal(15, 2)
  shippingCharges Decimal             @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal             @default(0) @db.Decimal(15, 2)
  total           Decimal             @default(0) @db.Decimal(15, 2)
  notes           String?
  termsConditions String?
  createdById     String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor       Contact             @relation(fields: [vendorId], references: [id])
  warehouse    Warehouse?          @relation(fields: [warehouseId], references: [id])
  createdBy    User?               @relation("PurchaseOrderCreatedBy", fields: [createdById], references: [id])
  items        PurchaseOrderItem[]
  bills        Bill[]
  receives     PurchaseReceive[]

  @@unique([organizationId, orderNumber])
  @@index([organizationId])
  @@index([vendorId])
  @@index([warehouseId])
  @@index([status])
  @@index([orderDate])
}

model PurchaseOrderItem {
  id              String       @id @default(cuid())
  purchaseOrderId String
  itemId          String
  description     String?
  quantity        Decimal      @db.Decimal(15, 4)
  receivedQty     Decimal      @default(0) @db.Decimal(15, 4)
  billedQty       Decimal      @default(0) @db.Decimal(15, 4)
  unit            String
  unitPrice       Decimal      @db.Decimal(15, 4)
  discountType    DiscountType @default(PERCENTAGE)
  discountPercent Decimal      @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal      @default(0) @db.Decimal(15, 2)
  taxRateId       String?
  taxAmount       Decimal      @default(0) @db.Decimal(15, 2)
  total           Decimal      @db.Decimal(15, 2)
  sortOrder       Int          @default(0)

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [id])

  @@index([purchaseOrderId])
  @@index([itemId])
}

model Bill {
  id                String        @id @default(cuid())
  organizationId    String
  billNumber        String
  purchaseOrderId   String?
  purchaseReceiveId String?
  vendorId          String
  vendorBillNumber  String? // Vendor's invoice number
  billDate          DateTime      @default(now())
  dueDate           DateTime
  status            BillStatus    @default(DRAFT)
  paymentStatus     PaymentStatus @default(UNPAID)
  subtotal          Decimal       @default(0) @db.Decimal(15, 2)
  discountType      DiscountType  @default(PERCENTAGE)
  discountValue     Decimal       @default(0) @db.Decimal(15, 2)
  discountAmount    Decimal       @default(0) @db.Decimal(15, 2)
  taxAmount         Decimal       @default(0) @db.Decimal(15, 2)
  total             Decimal       @default(0) @db.Decimal(15, 2)
  amountPaid        Decimal       @default(0) @db.Decimal(15, 2)
  balance           Decimal       @default(0) @db.Decimal(15, 2)
  notes             String?
  createdById       String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  organization             Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchaseOrder            PurchaseOrder?            @relation(fields: [purchaseOrderId], references: [id])
  vendor                   Contact                   @relation(fields: [vendorId], references: [id])
  createdBy                User?                     @relation("BillCreatedBy", fields: [createdById], references: [id])
  items                    BillItem[]
  paymentAllocations       VendorPaymentAllocation[]
  vendorCreditApplications VendorCreditApplication[]

  @@unique([organizationId, billNumber])
  @@index([organizationId])
  @@index([vendorId])
  @@index([status])
  @@index([billDate])
  @@index([dueDate])
}

model BillItem {
  id          String  @id @default(cuid())
  billId      String
  itemId      String?
  accountId   String?
  description String?
  quantity    Decimal @db.Decimal(15, 4)
  unitPrice   Decimal @db.Decimal(15, 4)
  taxRateId   String?
  taxAmount   Decimal @default(0) @db.Decimal(15, 2)
  total       Decimal @db.Decimal(15, 2)
  sortOrder   Int     @default(0)

  // Relations
  bill Bill  @relation(fields: [billId], references: [id], onDelete: Cascade)
  item Item? @relation(fields: [itemId], references: [id])

  @@index([billId])
  @@index([itemId])
}

model VendorPayment {
  id                String            @id @default(cuid())
  organizationId    String
  paymentNumber     String
  vendorId          String
  paymentDate       DateTime          @default(now())
  amount            Decimal           @db.Decimal(15, 2)
  unallocatedAmount Decimal           @default(0) @db.Decimal(15, 2)
  paymentMethod     PaymentMethod
  referenceNumber   String?
  bankAccountId     String?
  isAdvancePayment  Boolean           @default(false)
  notes             String?
  status            TransactionStatus @default(COMPLETED)
  createdById       String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  vendor      Contact                   @relation(fields: [vendorId], references: [id])
  createdBy   User?                     @relation("VendorPaymentCreatedBy", fields: [createdById], references: [id])
  allocations VendorPaymentAllocation[]

  @@unique([organizationId, paymentNumber])
  @@index([organizationId])
  @@index([vendorId])
  @@index([paymentDate])
}

model VendorPaymentAllocation {
  id              String   @id @default(cuid())
  vendorPaymentId String
  billId          String
  amount          Decimal  @db.Decimal(15, 2)
  createdAt       DateTime @default(now())

  // Relations
  vendorPayment VendorPayment @relation(fields: [vendorPaymentId], references: [id], onDelete: Cascade)
  bill          Bill          @relation(fields: [billId], references: [id])

  @@index([vendorPaymentId])
  @@index([billId])
}

// ============================================
// PURCHASE RECEIVES
// ============================================

model PurchaseReceive {
  id              String                   @id @default(cuid())
  organizationId  String
  receiveNumber   String
  purchaseOrderId String?
  vendorId        String
  warehouseId     String
  receiveDate     DateTime                 @default(now())
  referenceNumber String?
  notes           String?
  status          ReceiveTransactionStatus @default(RECEIVED)
  createdById     String?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  // Relations
  purchaseOrder PurchaseOrder?        @relation(fields: [purchaseOrderId], references: [id])
  vendor        Contact               @relation(fields: [vendorId], references: [id])
  warehouse     Warehouse             @relation(fields: [warehouseId], references: [id])
  createdBy     User?                 @relation("PurchaseReceiveCreatedBy", fields: [createdById], references: [id])
  items         PurchaseReceiveItem[]

  @@unique([organizationId, receiveNumber])
  @@index([organizationId])
  @@index([purchaseOrderId])
  @@index([vendorId])
  @@index([receiveDate])
}

model PurchaseReceiveItem {
  id                  String   @id @default(cuid())
  purchaseReceiveId   String
  itemId              String
  purchaseOrderItemId String?
  description         String?
  orderedQty          Decimal  @default(0) @db.Decimal(15, 4)
  receivedQty         Decimal  @db.Decimal(15, 4)
  acceptedQty         Decimal  @db.Decimal(15, 4)
  rejectedQty         Decimal  @default(0) @db.Decimal(15, 4)
  rejectionReason     String?
  unitCost            Decimal  @default(0) @db.Decimal(15, 4)
  batchNumber         String?
  serialNumbers       String[]

  // Relations
  purchaseReceive PurchaseReceive @relation(fields: [purchaseReceiveId], references: [id], onDelete: Cascade)
  item            Item            @relation(fields: [itemId], references: [id])

  @@index([purchaseReceiveId])
  @@index([itemId])
}

// ============================================
// SETTINGS & CONFIGURATION
// ============================================

model TaxRate {
  id             String    @id @default(cuid())
  organizationId String
  name           String
  code           String // Tax code e.g., "ST10", "ST6", "ZR", "EX"
  rate           Decimal   @db.Decimal(5, 2)
  type           TaxType   @default(SST)
  description    String?
  isDefault      Boolean   @default(false)
  isActive       Boolean   @default(true)
  status         Status    @default(ACTIVE)
  effectiveFrom  DateTime?
  effectiveTo    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items        Item[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([type])
  @@index([isActive])
}

model OrganizationTaxSettings {
  id                   String         @id @default(cuid())
  organizationId       String         @unique
  isSstRegistered      Boolean        @default(false)
  sstRegistrationNo    String?
  sstRegisteredDate    DateTime?
  sstThreshold         Decimal?       @db.Decimal(15, 2) // RM 500,000
  defaultSalesTaxId    String?
  defaultPurchaseTaxId String?
  taxInclusive         Boolean        @default(false)
  roundingMethod       RoundingMethod @default(NORMAL)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  @@index([organizationId])
}

model PaymentTerm {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  days           Int
  description    String?
  isDefault      Boolean  @default(false)
  isActive       Boolean  @default(true)
  status         Status   @default(ACTIVE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts     Contact[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model PriceList {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  description    String?
  type           PriceListType @default(SALES)
  markupType     DiscountType  @default(PERCENTAGE)
  markupValue    Decimal       @default(0) @db.Decimal(10, 2)
  isDefault      Boolean       @default(false)
  status         Status        @default(ACTIVE)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts     Contact[]

  @@index([organizationId])
  @@index([type])
}

// ============================================
// ENUMS
// ============================================

enum Industry {
  AUTO_PARTS
  HARDWARE
  SPARE_PARTS
  GENERAL
}

enum Status {
  ACTIVE
  INACTIVE
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
  VIEWER
}

enum ItemType {
  INVENTORY
  SERVICE
  NON_INVENTORY
}

enum ContactType {
  CUSTOMER
  VENDOR
  BOTH
}

enum SerialStatus {
  IN_STOCK
  SOLD
  RETURNED
  DAMAGED
}

enum AdjustmentType {
  INCREASE
  DECREASE
}

enum TransferStatus {
  DRAFT
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

enum TransactionStatus {
  DRAFT
  PENDING
  COMPLETED
  CANCELLED
}

enum ReceiveTransactionStatus {
  PENDING
  RECEIVED
  CANCELLED
}

enum SalesOrderStatus {
  DRAFT
  CONFIRMED
  PACKED
  SHIPPED
  DELIVERED
  CLOSED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  VOID
  NOT_INVOICED
  PARTIALLY_INVOICED
  INVOICED
}

enum PaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
}

enum ShipmentStatus {
  NOT_SHIPPED
  PARTIALLY_SHIPPED
  SHIPPED
}

enum PurchaseOrderStatus {
  DRAFT
  ISSUED
  PARTIALLY_RECEIVED
  RECEIVED
  CLOSED
  CANCELLED
}

enum ReceiveStatus {
  NOT_RECEIVED
  PARTIALLY_RECEIVED
  RECEIVED
}

enum BillStatus {
  DRAFT
  RECEIVED
  PARTIALLY_PAID
  PAID
  OVERDUE
  VOID
  NOT_BILLED
  PARTIALLY_BILLED
  BILLED
}

enum TaxType {
  SST // Sales and Service Tax (10%)
  SERVICE_TAX // Service Tax (6%)
  EXEMPT
  ZERO_RATED
  OUT_OF_SCOPE // Outside SST scope
}

enum RoundingMethod {
  NORMAL
  ROUND_DOWN
  ROUND_UP
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  CREDIT_CARD
  FPX
  DUITNOW
  GRABPAY
  TNG_EWALLET
  OTHER
}

enum PriceListType {
  SALES
  PURCHASE
}

enum EInvoiceStatus {
  PENDING
  SUBMITTED
  VALIDATED
  REJECTED
  CANCELLED
}

// ============================================
// EMAIL NOTIFICATIONS
// ============================================

model EmailLog {
  id             String      @id @default(cuid())
  type           EmailType
  to             String
  cc             String?
  subject        String
  body           String?     @db.Text
  status         EmailStatus @default(PENDING)
  sentAt         DateTime?
  error          String?     @db.Text
  referenceType  String? // 'invoice', 'payment', 'sales_order', 'purchase_order'
  referenceId    String?
  organizationId String
  createdById    String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([organizationId, type])
  @@index([referenceType, referenceId])
  @@index([status])
}

model OrganizationEmailSettings {
  id              String   @id @default(cuid())
  organizationId  String   @unique
  smtpHost        String?
  smtpPort        Int?     @default(587)
  smtpSecure      Boolean  @default(true)
  smtpUser        String?
  smtpPass        String? // Should be encrypted in production
  fromName        String?
  fromEmail       String?
  replyTo         String?
  signature       String?  @db.Text
  autoSendInvoice Boolean  @default(false)
  autoSendPayment Boolean  @default(false)
  autoSendOrder   Boolean  @default(false)
  autoSendPO      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum EmailType {
  INVOICE_CREATED
  PAYMENT_RECEIVED
  ORDER_CONFIRMED
  PO_ISSUED
  CUSTOM
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

// ============================================
// SALES RETURNS & CREDIT NOTES
// ============================================

model SalesReturn {
  id             String            @id @default(cuid())
  organizationId String
  returnNumber   String
  invoiceId      String?
  invoice        Invoice?          @relation(fields: [invoiceId], references: [id])
  salesOrderId   String?
  salesOrder     SalesOrder?       @relation(fields: [salesOrderId], references: [id])
  customerId     String
  customer       Contact           @relation("SalesReturnCustomer", fields: [customerId], references: [id])
  returnDate     DateTime          @default(now())
  status         ReturnStatus      @default(PENDING)
  reason         ReturnReason
  notes          String?
  subtotal       Decimal           @default(0) @db.Decimal(15, 2)
  taxAmount      Decimal           @default(0) @db.Decimal(15, 2)
  total          Decimal           @default(0) @db.Decimal(15, 2)
  creditNoteId   String?
  creditNote     CreditNote?       @relation(fields: [creditNoteId], references: [id])
  warehouseId    String?
  warehouse      Warehouse?        @relation(fields: [warehouseId], references: [id])
  restockItems   Boolean           @default(true)
  createdById    String?
  createdBy      User?             @relation("SalesReturnCreatedBy", fields: [createdById], references: [id])
  approvedById   String?
  approvedBy     User?             @relation("SalesReturnApprovedBy", fields: [approvedById], references: [id])
  approvedAt     DateTime?
  receivedById   String?
  receivedBy     User?             @relation("SalesReturnReceivedBy", fields: [receivedById], references: [id])
  receivedAt     DateTime?
  items          SalesReturnItem[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@unique([organizationId, returnNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@index([returnDate])
}

model SalesReturnItem {
  id            String        @id @default(cuid())
  salesReturnId String
  salesReturn   SalesReturn   @relation(fields: [salesReturnId], references: [id], onDelete: Cascade)
  itemId        String
  item          Item          @relation(fields: [itemId], references: [id])
  quantity      Decimal       @db.Decimal(15, 4)
  unitPrice     Decimal       @db.Decimal(15, 4)
  taxAmount     Decimal       @default(0) @db.Decimal(15, 2)
  total         Decimal       @db.Decimal(15, 2)
  condition     ItemCondition @default(GOOD)
  restocked     Boolean       @default(false)

  @@index([salesReturnId])
  @@index([itemId])
}

model CreditNote {
  id             String                  @id @default(cuid())
  organizationId String
  creditNumber   String
  customerId     String
  customer       Contact                 @relation("CreditNoteCustomer", fields: [customerId], references: [id])
  creditDate     DateTime                @default(now())
  salesReturnId  String?
  subtotal       Decimal                 @default(0) @db.Decimal(15, 2)
  taxAmount      Decimal                 @default(0) @db.Decimal(15, 2)
  total          Decimal                 @default(0) @db.Decimal(15, 2)
  balance        Decimal                 @default(0) @db.Decimal(15, 2)
  status         CreditNoteStatus        @default(OPEN)
  notes          String?
  createdById    String?
  createdBy      User?                   @relation("CreditNoteCreatedBy", fields: [createdById], references: [id])
  items          CreditNoteItem[]
  applications   CreditNoteApplication[]
  salesReturns   SalesReturn[]
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  @@unique([organizationId, creditNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
}

model CreditNoteItem {
  id           String     @id @default(cuid())
  creditNoteId String
  creditNote   CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  description  String
  quantity     Decimal    @default(1) @db.Decimal(15, 4)
  unitPrice    Decimal    @db.Decimal(15, 4)
  taxAmount    Decimal    @default(0) @db.Decimal(15, 2)
  total        Decimal    @db.Decimal(15, 2)

  @@index([creditNoteId])
}

model CreditNoteApplication {
  id           String     @id @default(cuid())
  creditNoteId String
  creditNote   CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  invoiceId    String
  invoice      Invoice    @relation(fields: [invoiceId], references: [id])
  amount       Decimal    @db.Decimal(15, 2)
  appliedDate  DateTime   @default(now())
  createdById  String?

  @@index([creditNoteId])
  @@index([invoiceId])
}

enum ReturnStatus {
  PENDING
  APPROVED
  RECEIVED
  PROCESSED
  REJECTED
}

enum ReturnReason {
  DEFECTIVE
  WRONG_ITEM
  CHANGED_MIND
  NOT_AS_DESCRIBED
  QUALITY_ISSUE
  DUPLICATE_ORDER
  OTHER
}

enum ItemCondition {
  GOOD
  DAMAGED
  DEFECTIVE
}

enum CreditNoteStatus {
  OPEN
  PARTIALLY_APPLIED
  FULLY_APPLIED
  VOID
}

// ============================================
// VENDOR CREDITS
// ============================================

model VendorCredit {
  id             String                    @id @default(cuid())
  organizationId String
  creditNumber   String
  vendorId       String
  vendor         Contact                   @relation("VendorCreditVendor", fields: [vendorId], references: [id])
  creditDate     DateTime                  @default(now())
  reference      String?
  subtotal       Decimal                   @default(0) @db.Decimal(15, 2)
  taxAmount      Decimal                   @default(0) @db.Decimal(15, 2)
  total          Decimal                   @default(0) @db.Decimal(15, 2)
  balance        Decimal                   @default(0) @db.Decimal(15, 2)
  status         VendorCreditStatus        @default(OPEN)
  reason         String?
  notes          String?
  createdById    String?
  createdBy      User?                     @relation("VendorCreditCreatedBy", fields: [createdById], references: [id])
  items          VendorCreditItem[]
  applications   VendorCreditApplication[]
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt

  @@unique([organizationId, creditNumber])
  @@index([organizationId])
  @@index([vendorId])
  @@index([status])
}

model VendorCreditItem {
  id             String       @id @default(cuid())
  vendorCreditId String
  vendorCredit   VendorCredit @relation(fields: [vendorCreditId], references: [id], onDelete: Cascade)
  description    String
  quantity       Decimal      @default(1) @db.Decimal(15, 4)
  unitPrice      Decimal      @db.Decimal(15, 4)
  taxAmount      Decimal      @default(0) @db.Decimal(15, 2)
  total          Decimal      @db.Decimal(15, 2)

  @@index([vendorCreditId])
}

model VendorCreditApplication {
  id             String       @id @default(cuid())
  vendorCreditId String
  vendorCredit   VendorCredit @relation(fields: [vendorCreditId], references: [id], onDelete: Cascade)
  billId         String
  bill           Bill         @relation(fields: [billId], references: [id])
  amount         Decimal      @db.Decimal(15, 2)
  appliedDate    DateTime     @default(now())
  createdById    String?

  @@index([vendorCreditId])
  @@index([billId])
}

enum VendorCreditStatus {
  OPEN
  PARTIALLY_APPLIED
  FULLY_APPLIED
  VOID
}
